<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Open Movie</title><meta name="Description" content="Open Movie Website"><link href="styles.8ca34bc7cbff983a9131.css" rel="stylesheet"></head><body><div id="search"><input onkeyup="onSearch(this.value)" placeholder="Search.."></div><div id="movies"></div><script>let state = {
    page: 1, // Counts how many pages loaded
    totalMovies: 0, // Number of Total Movies
    searchedText: '', // Search text
    resultsPerPage: 10, // Number of results per page
    api: 'http://www.omdbapi.com/?apikey=aba065d3', // Api Url
};

const { body } = document;

/* ---------------------------------- Utility Functions ------------------------------------------ */

// Determines first time loading vs lazy load pagination
const ifLoadingMore = () =>  state.page > 1;

// Creates an DOM element from a given string html
const createElementFromHTML = htmlString => {
    const div = document.createElement('div');
    div.innerHTML = htmlString.trim();
    return div.firstChild;
};

// Loader element
const loader = '<div id="loader"></div>';
const loaderDetail = '<div id="loader" class="detail"></div>';
const notFound = info => `<h2 id="not-found">${info}</h2>`;

// Debounce utility function
const debounce = (fn, time) => {
    let timeout;
    return function() {
        const functionCall = () => fn.apply(this, arguments);
        clearTimeout(timeout);
        timeout = setTimeout(functionCall, time);
    }
};

// Cleans utility elements and renders callback element
const safeAppend = (content, whereToAppend = body) => {

    // Remove notFound element if exist
    const notFoundDOM = document.getElementById('not-found');
    notFoundDOM && notFoundDOM.remove();

    // Remove loading element if exist
    const loaderDOM = document.getElementById('loader');
    loaderDOM && loaderDOM.remove();

    // Remove previous movies if first time loading
    const moviesDOM = document.getElementById('movies');
    if (!ifLoadingMore()) {
        moviesDOM.innerHTML = '';
    }

    // Append proper element into DOM
    whereToAppend.insertAdjacentHTML('beforeend', content);

};

const onSearch = debounce(e => e.length && onSearchDebounced(e), 1000);

// Create rating DOM
const createRatings = ratings => {
    const domString = `
        <ul class="rating">
            ${ratings.map(({Source, Value}) => `<li><strong>${Source}</strong> ${Value} </li>`).join("")}
        </ul>
    `;
    return createElementFromHTML(domString)
};

// Create movies DOM
const createMovies = movies => `
    ${movies.map(({Title, Poster, Type, imdbID}) => `
        <div class="box" id=${imdbID} onmouseover="getDetails(this)">
            <img src=${Poster}/>
            <div title=${Title} class="title center main">${Title}</div>
            <div class="type center">${Type}</div>
        </div>
    `).join("")}
`;

// Create details DOM
const createDetails = ({Title, Director, Year}) => {
    const domString = `
        <div class="details">
            <div title=${Title} class="title">${Title}</div>
            <div class="list">Year: <strong>${Year}</strong></div>
            <div class="list">Directed By: <strong>${Director}</strong></div>
        </div>
    `;
    return createElementFromHTML(domString)
};

// Resetting all values to initial
const resetSearch = value => {
    state = {...state, searchedText: value, page: 1, totalMovies: 0}
};

// Search Function
const onSearchDebounced = (value = state.searchedText) => {
    // 1 - if search text is a new text reset all values
    if (state.searchedText !== value) {
        resetSearch(value);
    }
    // 2 - Render Loader
    safeAppend(loader);

    // 3 - Fetch Api
    fetch(`${state.api}&page=${state.page}&s=${value}`)
        .then((response) => response.json())
        .then((responseData) => {
            const {Search, totalResults, Response, Error} = responseData;

            // 4 - Update state with new result
            state = {...state, totalMovies: Number(totalResults)};

            // 5 - if has result create movies DOM and append into body
            if (JSON.parse(Response.toLowerCase())) {
                const moviesDom = document.getElementById('movies');
                safeAppend(createMovies(Search), moviesDom);
            } else {
                // 6 - if no result show notFound message
                safeAppend(notFound(Error))
            }
        }).
        catch(err => {
            // 7 - if network error show error message
            safeAppend(notFound(err.message))
        });

    // 8 - increase page count
    state.page++;
};

const getDetails = boxElement => {
    const { id, lastElementChild: { className: boxClassList } } = boxElement;

    // 1 - Fetch api call to get details if we don't have yet
    if (!boxClassList.includes('details')) {

        // 2 - show loading animation
        boxElement.insertAdjacentHTML('beforeend', loaderDetail);

        // 3 - Fetch detail info
        fetch(`${state.api}&i=${id}`)
            .then((response) => response.json())
            .then((responseData) => {

                // 4 - Remove Loading Animation
                const { lastChild } = boxElement;
                if (lastChild.id === 'loader') {
                    boxElement.removeChild(lastChild);
                }

                // 5 - Create Detail element && append
                const { Ratings } = responseData;
                const detailElement = createDetails(responseData);
                detailElement.appendChild(createRatings(Ratings));
                boxElement.appendChild(detailElement);

                // 6 - Give time for rendering and start animation
                setTimeout(() => detailElement.className += ' show', 100)
            }).
        catch(() => {
            // 7 - if any errors remove loading animation
            const { lastChild } = boxElement;
            if (lastChild.id === 'loader') {
                boxElement.removeChild(lastChild);
            }
        });
    }
};

// on scroll bottom trigger fetch function if we have data to load
window.onscroll = function() {
  const { documentElement } = document;
  const { offsetHeight } = documentElement;
  const offset = documentElement.scrollTop + window.innerHeight;
  if (offset === offsetHeight && (state.totalMovies > state.resultsPerPage * (state.page - 1))) {
      onSearchDebounced();
  }
};</script><script src="main.b986f756f641272865af.js"></script></body></html>